version: '3'
 
services:
  postgres:
    container_name: mattfm_sql
    image: postgres
    hostname: mattfm_sql
    networks:
      mfmnet:
        ipv4_address: 172.19.0.4
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - ./database:/matt-fm
      - ./database/matt-fm.sql:/docker-entrypoint-initdb.d/matt-fm.sql
    restart: unless-stopped

  pgadmin:
    container_name: mattfm_sql_admin
    image: dpage/pgadmin4
    depends_on:
      - postgres
    hostname: mattfm_sql_admin
    networks:
      mfmnet:
        ipv4_address: 172.19.0.5
    ports:
      - "8080:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: pgadmin4@pgadmin.org
      PGADMIN_DEFAULT_PASSWORD: admin
    restart: unless-stopped

  rust:
    container_name: mattfm_api
    image: rust
    depends_on:
      - postgres
    hostname: mattfm_api
    networks:
      mfmnet:
        ipv4_address: 172.19.0.6
    ports:
      - "6676:6676"
    environment:
      DB_URL: postgres://postgres:postgres@172.19.0.4:5432/mattfm
      APP_ENV: prod 
    volumes:
      - ./api:/matt-fm
    command: bash -c "chmod +x /matt-fm/build.sh && ./matt-fm/build.sh"
    restart: unless-stopped

networks:
  mfmnet:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: "172.19.0.0/24"
          gateway: "172.19.0.1"
  # python:
  #   container_name: mattfm_dj
  #   image: python
  #   depends_on:
  #     - postgres
  #   hostname: mattfm_dj
  #   networks:
  #     mfmnet:
  #       ipv4_address: 172.19.0.3
  #   volumes:
  #     - ./matt-fm:/app
  #   command: bash -c "pip install --upgrade pip && pip install -r /matt.fm/requirements.txt && python3 /matt.fm/main.py"